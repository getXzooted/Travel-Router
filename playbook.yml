---
- name: Provision Secure Travel Gateway
  hosts: localhost
  connection: local
  become: yes
  vars_files:
    - config.yml

  tasks:
    # --- PHASE 1: PREPARATION (Internet Wide Open) ---
    - name: Set Hostname
      hostname:
        name: "{{ hostname }}"
    
    - name: Update /etc/hosts (Fixes sudo error)
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ hostname }}"
        state: present

    - name: Apply Sysctl Hardening
      copy:
        dest: /etc/sysctl.d/99-hardening.conf
        content: |
          net.ipv4.ip_forward=1
          net.ipv4.conf.all.accept_redirects=0
          net.ipv6.conf.all.disable_ipv6=1
          net.ipv6.conf.default.disable_ipv6=1
          net.ipv4.conf.all.log_martians=1
      notify: Apply Sysctl

    # --- PHASE 2: INSTALLATION (Needs Internet) ---
    - name: Install Dependencies
      apt:
        name: 
          - wireguard
          - iptables
        state: present
        update_cache: yes

    - name: Check RaspAP
      stat:
        path: /etc/raspap
      register: raspap_check

    - name: Install RaspAP (Automated)
      shell: curl -sL https://install.raspap.com | bash -s -- -y
      when: not raspap_check.stat.exists

    # --- PHASE 3: CONFIGURATION ---
    - name: Disable Bluetooth
      tags: config
      lineinfile:
        path: /boot/firmware/config.txt
        line: "dtoverlay=disable-bt"
        create: yes

    - name: Generate Private Key
      tags: config
      shell: wg genkey
      register: gen_key
      when: client_private_key | length == 0

    - name: Define Private Key Variable
      tags: config
      set_fact:
        final_private_key: "{{ gen_key.stdout if client_private_key | length == 0 else client_private_key }}"

    - name: Create Auto-DNS Script (VPN DNS Strategy)
      tags: config
      when: not use_unbound | default(false)   # <--- ONLY RUNS IF UNBOUND IS FALSE
      copy:
        dest: /usr/local/bin/auto-dns.sh
        mode: '0755'
        content: |
          #!/bin/bash
          sleep 2
          WG_IP=$(ip -o -4 addr list wg0 | awk '{print $4}' | cut -d/ -f1)
          WG_GATEWAY=$(echo $WG_IP | awk -F. '{print $1"."$2"."$3".1"}')
          echo -e "no-resolv\nserver=$WG_GATEWAY" > /etc/dnsmasq.d/02-vpn-dns.conf
          systemctl restart dnsmasq
    
    # --- UNBOUND SETUP (RECURSIVE RESOLVER) ---
    - name: Install Unbound
      when: use_unbound | default(false)
      apt:
        name: unbound
        state: present

    - name: Configure Unbound (Pi Zero Optimized)
      when: use_unbound | default(false)
      copy:
        dest: /etc/unbound/unbound.conf.d/pi-zero.conf
        content: |
          server:
            # Listening Info
            verbosity: 0
            interface: 127.0.0.1
            port: 5335
            do-ip4: yes
            do-udp: yes
            do-tcp: yes
            
            # Privacy & Security
            do-ip6: no
            access-control: 0.0.0.0/0 refuse
            access-control: 127.0.0.0/8 allow
            harden-glue: yes
            harden-dnssec-stripped: yes
            use-caps-for-id: no
            edns-buffer-size: 1232
            prefetch: yes
            
            # Pi Zero Resource Limits (Low RAM)
            num-threads: 1
            msg-cache-slabs: 2
            rrset-cache-slabs: 2
            infra-cache-slabs: 2
            key-cache-slabs: 2
            rrset-cache-size: 50m
            msg-cache-size: 25m
            so-rcvbuf: 1m

    - name: Point Hotspot to Unbound
      when: use_unbound | default(false)
      copy:
        dest: /etc/dnsmasq.d/02-vpn-dns.conf
        content: |
          no-resolv
          server=127.0.0.1#5335
      notify: Restart RaspAP

    - name: Restart Unbound
      when: use_unbound | default(false)
      service:
        name: unbound
        state: restarted
        enabled: yes

    - name: Create WireGuard Config (Clean)
      template:
        src: templates/wg0.conf.j2
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      notify: Restart WireGuard

    # --- PHASE 4: LOCKDOWN (The Safety Net) ---
    - name: Create Safety Net Script (Fixed Paths)
      copy:
        dest: /usr/local/bin/safety-net.sh
        mode: '0755'
        content: |
          #!/bin/bash
          IPT="/usr/sbin/iptables"
          
          # 1. DEFAULT POLICY: DROP (The Missing "1")
          # This is the "Universal Kill Switch". If we don't say YES, the answer is NO.
          $IPT -P INPUT DROP
          $IPT -P FORWARD DROP
          $IPT -P OUTPUT DROP
          
          # 2. FLUSH OLD RULES
          $IPT -F
          $IPT -X
          $IPT -t nat -F
          $IPT -t nat -X
          
          # 3. ALLOW ESTABLISHED CONNECTIONS (Crucial for Return Traffic)
          $IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
          $IPT -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
          $IPT -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

          # 4. UNIVERSAL LOCAL ACCESS (The Interface Fix)
          # Instead of guessing "wlan0" vs "uap0", we trust the Private IP Standards.
          # Allow traffic from ANY private LAN IP.
          $IPT -A INPUT -s 10.0.0.0/8 -j ACCEPT
          $IPT -A OUTPUT -d 10.0.0.0/8 -j ACCEPT
          $IPT -A INPUT -s 172.16.0.0/12 -j ACCEPT
          $IPT -A OUTPUT -d 172.16.0.0/12 -j ACCEPT
          $IPT -A INPUT -s 192.168.0.0/16 -j ACCEPT
          $IPT -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
          
          # Loopback (Internal Pi communication)
          $IPT -A INPUT -i lo -j ACCEPT
          $IPT -A OUTPUT -o lo -j ACCEPT

          # 5. ALLOW DHCP (Universal)
          $IPT -A INPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT
          $IPT -A OUTPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT

          # 6. ALLOW VPN TRANSPORT (The Only Way Out)
          $IPT -A OUTPUT -d {{ vpn_endpoint }} -p udp --dport {{ vpn_port }} -j ACCEPT
          
          # 7. ALLOW TUNNEL TRAFFIC (Inside the VPN)
          $IPT -A INPUT -i wg0 -j ACCEPT
          $IPT -A OUTPUT -o wg0 -j ACCEPT

          # 8. ENABLE FORWARDING (The Leak Fix)
          # We only allow forwarding if it goes INTO or OUT OF the VPN tunnel.
          # Since Policy is DROP (Section 1), any traffic skipping the VPN is killed automatically.
          $IPT -A FORWARD -i wg0 -j ACCEPT
          $IPT -A FORWARD -o wg0 -j ACCEPT

          # 9. NAT
          $IPT -t nat -A POSTROUTING -o wg0 -j MASQUERADE

    - name: Create Safety Net Service
      copy:
        dest: /etc/systemd/system/safety-net.service
        content: |
          [Unit]
          Description=Safety Net Firewall Rules
          After=network.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/safety-net.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Enable Safety Net Service
      systemd:
        name: safety-net
        enabled: yes
        state: started
        daemon_reload: yes

    # --- AUTO-PROVISIONING SYSTEM (Drag-and-Drop Keys) ---
    - name: Create Auto-Provisioning Script
      copy:
        dest: /usr/local/bin/provision-check.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # FILE: /usr/local/bin/provision-check.sh
          
          # Detect Boot Partition (Handles Bookworm /boot/firmware vs older /boot)
          if [ -d "/boot/firmware" ]; then
              BOOT_DIR="/boot/firmware"
          else
              BOOT_DIR="/boot"
          fi
          
          BOOT_CONFIG="$BOOT_DIR/provision.yml"
          PROJECT_DIR="/home/{{ ansible_user }}/secure-gateway"
          DEST_CONFIG="$PROJECT_DIR/config.yml"
          
          # 1. Check if a new provisioning file exists
          if [ -f "$BOOT_CONFIG" ]; then
              echo "New configuration found. Provisioning..."
              
              # 2. Move it to the project folder (Overwrite old config)
              mv "$BOOT_CONFIG" "$DEST_CONFIG"
              chown {{ ansible_user }}:{{ ansible_user }} "$DEST_CONFIG"
              chmod 600 "$DEST_CONFIG"
              
              # 3. Apply the new Configuration (Fast Run)
              # We verify the directory exists first to avoid errors
              if [ -d "$PROJECT_DIR" ]; then
                  cd "$PROJECT_DIR"
                  # Run only specific tags to update settings without full reinstall
                  sudo -u {{ ansible_user }} ansible-playbook playbook.yml --tags "config,wireguard,unbound,safety-net"
              fi
              
              # 4. Blink LED (Success Signal)
              # Turn off trigger to allow manual control
              echo none | tee /sys/class/leds/ACT/trigger > /dev/null
              echo 1 | tee /sys/class/leds/ACT/brightness
              sleep 0.2
              echo 0 | tee /sys/class/leds/ACT/brightness
              sleep 0.2
              echo 1 | tee /sys/class/leds/ACT/brightness
              sleep 0.2
              echo 0 | tee /sys/class/leds/ACT/brightness
              # Restore default heartbeat
              echo heartbeat | tee /sys/class/leds/ACT/trigger > /dev/null

              echo "Provisioning Complete. Rebooting..."
              reboot
          else
              echo "No provisioning file found. Booting normally."
          fi

    - name: Create Auto-Provisioning Service Unit
      copy:
        dest: /etc/systemd/system/auto-provision.service
        content: |
          [Unit]
          Description=Secure Gateway Auto-Provisioning
          After=network.target local-fs.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/provision-check.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Enable Auto-Provisioning Service
      systemd:
        name: auto-provision
        enabled: yes
        daemon_reload: yes

    - name: Create Auto-Provisioning Service Unit
      copy:
        dest: /etc/systemd/system/auto-provision.service
        content: |
          [Unit]
          Description=Auto-Provisioning Service
          After=network.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/provision-check.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Enable Auto-Provisioning Service
      systemd:
        name: auto-provision
        enabled: yes
        daemon_reload: yes

  handlers:
    - name: Apply Sysctl
      command: sysctl -p /etc/sysctl.d/99-hardening.conf

    - name: Restart WireGuard
      service:
        name: wg-quick@wg0
        state: restarted
    
    - name: Restart RaspAP
      service:
        name: dnsmasq
        state: restarted

  post_tasks:
    - name: FINAL SUMMARY
      debug:
        msg: "SETUP COMPLETE. Internet was kept open for install, then LOCKED."