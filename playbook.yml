---
- name: Provision Secure Travel Gateway
  hosts: localhost
  connection: local
  become: yes
  vars_files:
    - config.yml

  tasks:
    # --- PHASE 1: PREPARATION (Internet Wide Open) ---
    - name: Set Hostname
      hostname:
        name: "{{ hostname }}"
    
    - name: Update /etc/hosts (Fixes sudo error)
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\t{{ hostname }}"
        state: present

    - name: Apply Sysctl Hardening
      copy:
        dest: /etc/sysctl.d/99-hardening.conf
        content: |
          net.ipv4.ip_forward=1
          net.ipv4.conf.all.accept_redirects=0
          net.ipv6.conf.all.disable_ipv6=1
          net.ipv6.conf.default.disable_ipv6=1
          net.ipv4.conf.all.log_martians=1
      notify: Apply Sysctl

    # --- PHASE 2: INSTALLATION (Needs Internet) ---
    - name: Install Dependencies
      apt:
        name: 
          - wireguard
          - iptables
        state: present
        update_cache: yes

    - name: Check RaspAP
      stat:
        path: /etc/raspap
      register: raspap_check

    - name: Install RaspAP (Automated)
      shell: curl -sL https://install.raspap.com | bash -s -- -y
      when: not raspap_check.stat.exists

    # --- PHASE 3: CONFIGURATION ---
    - name: Disable Bluetooth
      lineinfile:
        path: /boot/firmware/config.txt
        line: "dtoverlay=disable-bt"
        create: yes

    - name: Generate Private Key
      shell: wg genkey
      register: gen_key
      when: client_private_key | length == 0

    - name: Define Private Key Variable
      set_fact:
        final_private_key: "{{ gen_key.stdout if client_private_key | length == 0 else client_private_key }}"

    - name: Create WireGuard Config (Clean)
      template:
        src: templates/wg0.conf.j2
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      notify: Restart WireGuard

    # --- PHASE 4: LOCKDOWN (The Safety Net) ---
    - name: Create Safety Net Script (Fixed Paths)
      copy:
        dest: /usr/local/bin/safety-net.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # DEFINITIONS (Crucial Fix for Systemd)
          IPT="/usr/sbin/iptables"
          
          # 1. FLUSH OLD RULES
          $IPT -P INPUT ACCEPT
          $IPT -P FORWARD ACCEPT
          $IPT -P OUTPUT ACCEPT
          $IPT -F
          $IPT -X
          
          # 2. ALLOW LOCAL TRAFFIC
          $IPT -A INPUT -i lo -j ACCEPT
          $IPT -A OUTPUT -o lo -j ACCEPT
          $IPT -A INPUT -i uap0 -j ACCEPT
          $IPT -A OUTPUT -o uap0 -j ACCEPT
          
          # 3. ALLOW DHCP & LAN
          $IPT -A INPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT
          $IPT -A OUTPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT
          $IPT -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
          $IPT -A OUTPUT -d 10.0.0.0/8 -j ACCEPT
          $IPT -A OUTPUT -d 172.16.0.0/12 -j ACCEPT

          # 4. ALLOW VPN CONNECTION (The only way out)
          $IPT -I OUTPUT -d {{ vpn_endpoint }} -p udp --dport {{ vpn_port }} -j ACCEPT
          
          # 5. BLOCK EVERYTHING ELSE (The Kill Switch)
          $IPT -A OUTPUT -o wlan0 -j REJECT
          $IPT -A OUTPUT -o eth0 -j REJECT

          # 6. ENABLE FORWARDING (The "Anti-Leak" Update)
          # A. Allow traffic meant for the VPN Tunnel
          $IPT -A FORWARD -i uap0 -o wg0 -j ACCEPT
          $IPT -A FORWARD -i wg0 -o uap0 -j ACCEPT

          # B. BLOCK EVERYTHING ELSE (The Forwarding Kill Switch)
          # If traffic from the phone tries to go anywhere else (like eth0 or wlan0), KILL IT.
          $IPT -A FORWARD -i uap0 -j REJECT

          # C. NAT (Sharing)
          $IPT -t nat -A POSTROUTING -o wg0 -j MASQUERADE

    - name: Create Safety Net Service
      copy:
        dest: /etc/systemd/system/safety-net.service
        content: |
          [Unit]
          Description=Safety Net Firewall Rules
          After=network.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/safety-net.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Enable Safety Net Service
      systemd:
        name: safety-net
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: Apply Sysctl
      command: sysctl -p /etc/sysctl.d/99-hardening.conf

    - name: Restart WireGuard
      service:
        name: wg-quick@wg0
        state: restarted

  post_tasks:
    - name: FINAL SUMMARY
      debug:
        msg: "SETUP COMPLETE. Internet was kept open for install, then LOCKED."